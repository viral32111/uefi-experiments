# This is a very large image, and will take a while to build.

# Everything is divided into separate stages & layers so that if something
#  breaks you do not have to rebuild the entire image.

# Due to the final size of this image (about 16GB), the final
#  builds are copied to the second Docker image.

# Instructions provided by...
#  https://wiki.osdev.org/Building_GCC
#  https://wiki.osdev.org/GCC_Cross-Compiler
#  https://gcc.gnu.org/install/
#  https://wiki.osdev.org/GNU-EFI

# See ./build.sh script for the command to build this image.

# Start the build image from Ubuntu LTS
FROM ubuntu:22.04

# Options for building & installing packages
ARG MAKE_JOBS=20 \
	DEBIAN_FRONTEND=noninteractive

# Options for downloading source trees
ARG BINUTILS_VERSION=2.38 \
	GMP_VERSION=6.2.1 \
	MPFR_VERSION=4.1.0 \
	MPC_VERSION=1.2.1 \
	GCC_VERSION=12.1.0 \
	GNUEFI_VERSION=3.0.14

# Options for building source trees
ENV BINUTILS_DIRECTORY=/opt/binutils \
	GMP_DIRECTORY=/opt/gmp \
	MPFR_DIRECTORY=/opt/mpfr \
	MPC_DIRECTORY=/opt/mpc \
	GCC_DIRECTORY=/opt/gcc \
	GNUEFI_DIRECTORY=/opt/gnuefi

# Options for building the cross-compiler
ARG CROSS_TARGET=i686-elf \
	CROSS_BINUTILS_DIRECTORY=/opt/cross/binutils \
	CROSS_GCC_DIRECTORY=/opt/cross/gcc

# Install the dependencies for building
# https://wiki.osdev.org/Building_GCC#Installing_Dependencies
RUN apt-get update && \
	apt-get install --no-install-recommends --yes \
		ca-certificates wget \
		build-essential make \
		texinfo \
		bison flex libisl-dev gcc-multilib \
		dejagnu tcl expect

# Download the source trees
# https://wiki.osdev.org/Building_GCC#Downloading_the_Source_Code
RUN mkdir --verbose --parents \
		/tmp/binutils/source /tmp/binutils/build ${BINUTILS_DIRECTORY} \
		/tmp/gmp/source /tmp/gmp/build ${GMP_DIRECTORY} \
		/tmp/mpfr/source /tmp/mpfr/build ${MPFR_DIRECTORY} \
		/tmp/mpc/source /tmp/mpc/build ${MPC_DIRECTORY} \
		/tmp/gcc/source /tmp/gcc/build ${GCC_DIRECTORY} \
		/tmp/gnuefi ${GNUEFI_DIRECTORY} \
		/tmp/cross/binutils/source /tmp/cross/binutils/build ${CROSS_BINUTILS_DIRECTORY} \
		/tmp/cross/gcc/source /tmp/cross/gcc/build ${CROSS_GCC_DIRECTORY} && \
	wget --progress dot:mega --output-document /tmp/binutils/source.tar.gz https://ftp.gnu.org/gnu/binutils/binutils-${BINUTILS_VERSION}.tar.gz 2>&1 && \
	wget --progress dot:mega --output-document /tmp/gmp/source.tar.gz https://gmplib.org/download/gmp/gmp-${GMP_VERSION}.tar.xz 2>&1 && \
	wget --progress dot:mega --output-document /tmp/mpfr/source.tar.gz https://www.mpfr.org/mpfr-${MPFR_VERSION}/mpfr-${MPFR_VERSION}.tar.gz 2>&1 && \
	wget --progress dot:mega --output-document /tmp/mpc/source.tar.gz https://ftp.gnu.org/gnu/mpc/mpc-${MPC_VERSION}.tar.gz 2>&1 && \
	wget --progress dot:mega --output-document /tmp/gcc/source.tar.gz https://mirrorservice.org/sites/sourceware.org/pub/gcc/releases/gcc-${GCC_VERSION}/gcc-${GCC_VERSION}.tar.gz 2>&1 && \
	wget --progress dot:mega --output-document /tmp/gnuefi/source.tar.bz2 https://sourceforge.net/projects/gnu-efi/files/gnu-efi-${GNUEFI_VERSION}.tar.bz2/download 2>&1

# Extract the downloaded source trees
RUN tar --verbose --extract --strip-components 1 --file /tmp/binutils/source.tar.gz --directory /tmp/binutils/source && \
	tar --verbose --extract --strip-components 1 --file /tmp/gmp/source.tar.gz --directory /tmp/gmp/source && \
	tar --verbose --extract --strip-components 1 --file /tmp/mpfr/source.tar.gz --directory /tmp/mpfr/source && \
	tar --verbose --extract --strip-components 1 --file /tmp/mpc/source.tar.gz --directory /tmp/mpc/source && \
	tar --verbose --extract --strip-components 1 --file /tmp/gcc/source.tar.gz --directory /tmp/gcc/source && \
	tar --verbose --extract --strip-components 1 --file /tmp/gnuefi/source.tar.bz2 --directory /tmp/gnuefi

# Copy source trees for building the cross-compiler
RUN	cp --verbose --archive /tmp/binutils/source /tmp/cross/binutils && \
	cp --verbose --archive /tmp/gcc/source /tmp/cross/gcc

# Build & install Binutils (this is quick)
# https://wiki.osdev.org/Building_GCC#Binutils
RUN cd /tmp/binutils/build && \
	../source/configure --prefix=${BINUTILS_DIRECTORY} --disable-nls --disable-werror && \
	make --jobs ${MAKE_JOBS} && \
	make install

# Build, test & install GMP
# https://gmplib.org/manual/Installing-GMP
RUN cd /tmp/gmp/build && \
	../source/configure --prefix=${GMP_DIRECTORY} && \
	make --jobs ${MAKE_JOBS} && \
	make check && \
	make install

# Build, test & install MPFR
# https://www.mpfr.org/mpfr-current/mpfr.html#Installing-MPFR
RUN cd /tmp/mpfr/build && \
	../source/configure --prefix=${MPFR_DIRECTORY} --with-gmp=${GMP_DIRECTORY} && \
	make --jobs ${MAKE_JOBS} && \
	make check && \
	make install

# Build, test & install MPC
# https://multiprecision.org/downloads/mpc-1.2.1.pdf
RUN cd /tmp/mpc/build && \
	../source/configure --prefix=${MPC_DIRECTORY} --with-gmp=${GMP_DIRECTORY} --with-mpfr=${MPFR_DIRECTORY} && \
	make --jobs ${MAKE_JOBS} && \
	make check && \
	make install

# Build & install GCC with bootstrapping
# https://wiki.osdev.org/Building_GCC#GCC
# NOTE: We don't run tests here because they take way too long
RUN cd /tmp/gcc/build && \
	../source/configure --prefix=${GCC_DIRECTORY} --with-gmp=${GMP_DIRECTORY} --with-mpfr=${MPFR_DIRECTORY} --with-mpc=${MPC_DIRECTORY} --disable-nls --enable-languages=c,c++ && \
	make --jobs ${MAKE_JOBS} && \
	make install

# Remove the old compiler & former build dependencies
RUN apt-get remove --purge --autoremove --yes \
		ca-certificates wget \
		gcc g++ gcc-multilib

# Add Binutils and GCC to the PATH
ENV PATH="${BINUTILS_DIRECTORY}/bin:${GCC_DIRECTORY}/bin:$PATH"

# Build & install GNU-EFI
# https://wiki.osdev.org/GNU-EFI#Requirements
RUN cd /tmp/gnuefi && \
	make --jobs ${MAKE_JOBS} && \
	make PREFIX=${GNUEFI_DIRECTORY} install && \
	mv -v ${GNUEFI_DIRECTORY}/lib/crt0-efi-x86_64.o ${GNUEFI_DIRECTORY}/crt0-efi-x86_64.o && \
	mv -v ${GNUEFI_DIRECTORY}/lib/elf_x86_64_efi.lds ${GNUEFI_DIRECTORY}/elf_x86_64_efi.lds

# Build Binutils as a cross-compiler
# https://wiki.osdev.org/GCC_Cross-Compiler#Binutils
RUN cd /tmp/cross/binutils/build && \
	../source/configure --target=${CROSS_TARGET} --prefix=${CROSS_BINUTILS_DIRECTORY} --with-sysroot --disable-nls --disable-werror && \
	make --jobs ${MAKE_JOBS} && \
	make install

# Add the cross-compiler Binutils to the PATH
ENV PATH="${CROSS_BINUTILS_DIRECTORY}/bin:$PATH"

# Build GCC as a cross-compiler without bootstrapping
# https://wiki.osdev.org/GCC_Cross-Compiler#GCC
RUN cd /tmp/cross/gcc/build && \
	../source/configure --target=${CROSS_TARGET} --prefix=${CROSS_GCC_DIRECTORY} --with-gmp=${GMP_DIRECTORY} --with-mpfr=${MPFR_DIRECTORY} --with-mpc=${MPC_DIRECTORY} --disable-nls --enable-languages=c,c++ --disable-bootstrap --without-headers && \
	make --jobs ${MAKE_JOBS} all-gcc && \
	make --jobs ${MAKE_JOBS} all-target-libgcc && \
	make install-gcc && \
	make install-target-libgcc

# Add the cross-compiler GCC to the PATH
ENV PATH="${CROSS_GCC_DIRECTORY}/bin:$PATH"

# Remove build dependencies & temporary files
RUN apt-get remove --purge --autoremove --yes \
		build-essential make \
		texinfo \
		bison flex libisl-dev \
		dejagnu tcl expect && \
	rm --verbose --force --recursive \
		/tmp/* \
		/var/lib/apt/lists/*

# Continues in the second Docker image...
